[TOC]

---

# 基于闪存的SSD适用的高性能轻量级事务协议



## Abstract

现状-主题-亮点（发现问题-解决问题-结果）

- 现有的基于闪存的SSD的嵌入式事务协议设计要么限制了事务的并发性，要么追踪事务状态开销过大，导致SSD性能下降或不稳定。
- 本文提出一种LightTx，能更好的支持事务的并发性，同时满足低开销。它主要实现了3个方面的任务：
  - 它采用页独立提交方式（page-independent commit protocol）改进了事务的并发性能。
  - 它利用SSD的近日志结构更新（near-log-structured ）的特性追踪最后的数据更新。
  - 周期性的回收过期事务减少事务跟踪开销。
- 实验表明，相比于已有的嵌入式事务协议，LightTx在垃圾回收、内存消耗、映射持久化方面近乎最低的开销，同时在事务并发性能上的提升达到20.6%。



PS：摘要表明现有的SSD嵌入式事务协议存在问题，并提出一种更好的解决方案LightTx，能获得客观的性能提升。

---

## Introduction

《1》

- 事务被广泛应用于数据库管理系统、文件系统和应用中，为之提供ACID特性的同时，引起了实现复杂度和性能降低的问题。
- 事务恢复，作为保证原子性和持久性的关键，是事务管理的基本组成部分。
- 在事务恢复中，一个写操作需要保证目标页空间的旧数据在新数据成功更新前是安全可靠的，一旦更新失败，需要保证一致性。
- WAL（write ahead logging）和影子页（shadow paging）技术是目前事务恢复的两种主要方法。
  - 在WAL方式中，写操作在log中更新数据，在旧版本数据原地更新之前同步到磁盘中去。额外的log写操作和同步操作使得该方法开销巨大。
- 而影子页方式中，在新的页中更新数据之后，重写数据到与新页关联的影子页中。这种方式造成数据存储空间分散，降低读访问的性能。
- 闪存的不可重复写和随机读写可以改善影子页方法。闪存中页必须在写前擦除，为了隐藏擦除实质，基于闪存的SSD重定向写入数据到一个空页，同时将旧页置无效状态，且在FTL层用一张映射表维护它们之间的一对映射关系。故在SSD中简单地更新FTL的映射表中的映射项就能实现页的原子性更新。由于FTL映射表的这种简便性，使得人们愿意尝试在SSD内部提供事务支持。

《2》

最近的研究提出，引入一种新的接口-原子写，同时提供多页原子性更新，以支持在SSD内部实现事务。在SSD内部支持事务，可以将系统从高消耗的事务恢复中解脱出来，这样减除日志复写操作可以近乎倍增系统性能。但是，这些研究提供的方案仅支持有限的隔离等级，主要是strict isolation，这仅适用与序列化的事务（并发效果差或不支持并发）。这限制了事务的并发性，降低了存储设备的事务效率。原因如下，一，不同系统在不同的事务隔离等级环境下对一致性要求和性能要求具有不同的权衡，不能广泛支持多种隔离等级使得系统兼容性差。二、strict isolation隔离等级制约了SSD中的事务并发请求数，不利于系统并行化（如不同位面不同通道页面的同步更新）。strict isolation隔离等级环境下，事务间必须的等待（新事务必须等待之前事务的完成）造成了SSD不能充分利用。



另一方面，在SSD内部支持事务恢复时，保持低开销是很重要的。然而，易扩展的事务支持，事务中止以及快速恢复的需求导致了系统的高消耗。首先，当事务并发执行时，检测每个事务状态需要对页状态进行追踪，这会造成大量内存开销。其次，事务中止增加了垃圾回收开销，比如擦除块所需的时间开销、从擦除块中移出有效页数据的开销，这是因为这些额外的限制在垃圾回收时是不可避免的，以免感染那些被用来存放提交协议的页空间。最后是映射持久化开销，比如，将FTL映射表写入闪存设备的时间开销，这在快速恢复时的开销会非常高。快速恢复需要FTL映射表能够在每个事务提交的时候持久化，这导致了高开销。



《3》

本文的目标是设计一个支持多种隔离等级的SSD事务协议（TxSSD），且能在SSD内部保证原子性和持久性，同时在消耗、垃圾回收、映射持久化方面拥有低的硬件开销。

关键思想：我们对FTL做了两个主要的变化以达到上述的目标，我们把它称之为LightTx：

- 既然SSD不可重复写的特性允许页数据的不同版本同时在不同空间上更新，那么控制映射表项更新的序列就能确定不同版本的更新顺序。LightTx通过允许页独立更新以支持任意的事务并发。一个版本的页更新直到它在FTL映射表中的映射表项更新到新的页空间之后才是有效的。LightTx在事务提交时才更新FTL中的映射表，而不是像传统系统那样发生写操作就更新，这保证了一致性。另外，LightTx给每一次写操作标注了一个事务id（TxID），以确定每一个事务的提交或未提交状态，这保证了事务状态可被独立的确定。LightTx的事务提交协议被设计成页独立的，它支持在同一页上的更新操作的并发事务执行。
- SSD的近日志结构更新特性使得以低消耗去追踪最近的写事务以及撤除过期事务变得可能。在分配页的时候，每个页连续得从每个干净的块中被分配，这使得页更新能够按照一种近日志结构的规则被依次执行。但是，不同并行单元（如信道）上的多个干净块同时被用作分配时，页的分配在多个位面上执行，并且每个位面都保持日志结构更新规则。我们称之为SSD的近日志结构更新特性。利用这个特性，LightTx追踪这些被分配的块，就能追踪到最近的写操作。当一个事务对应的页和映射表项原子更新并持久化之后，这个事务就是一个死亡事务，这种情况下，被提交的事务的页空间能通过FTL映射表访问，而未提交的事务的页空间则不能。考虑到事务的生命周期，LightTx周期性得鉴定并且撤除死亡事务，并且通过新的基于区域的方案只追踪存活的事务。这与之前已有研究提出的死亡事务也被追踪相反。LightTx的新的基于区域的事务状态追踪方案能够在低消耗状态下追踪鉴别事务。

成果：这是我们已知的首篇在SSD内部实现的低开销支持多样事务隔离等级的论文，为了实现这种机制，本文做出了一下的一些成果：

- 将并发控制与单个事务恢复解耦。通过一个扩展的SSD事务接口，分别采用软件和硬件各自管理这两种操作。这样既能支持多样事务的并发控制，又能充分利用SSD在事务恢复中的优点。
- 我们提出的LightTx，使用一种新颖的页独立提交协议，通过在FTL的映射表中控制更新顺序，提高了事务并发性。
- 我们为LightTx设计了新的基于区域的事务状态追踪策略，只追踪存活的事务且周期性的检测和撤销死亡事务减少了事务状态追踪开销，使得LightTx成为一种轻量级的设计。
- 我们通过数据库在性能和开销两方面评估了LightTx，包括它的垃圾回收、内存消耗、映射持久化三方面的开销。结果显示，相比已有的嵌入式事务设计，LightTx在保持高性能的情况下近乎能达到最低的开销。



PS：概述部分分为三节。首先介绍了上层应用中的事务机制，着重介绍了WAL和SP两种事务恢复机制的优缺点，从而引出基于闪存的事务机制，利用闪存优良特性能摒弃前两者的缺点，提升事务性能。接着第二部分讲述了目前现有研究围绕基于闪存的事务机制做出的成果，但同时遇到了新的瓶颈，主要在并发性、兼容性、系统开销三方面存在障碍。最后第三部分提出本文的解决方案：LightTx，以及该方案针对上述三个问题的解决思路。

----

## Background & Related Work

### 基于闪存的SSD

基于闪存的SSD由多块闪存片通过不同通道连接而组成。每个闪存片又有多个面，每个面上有许多存储块，一个块又由许多的页组成，而一个闪存页是闪存的基本读写单元。通常的闪存页大小为4KB，其中包含128B的页元数据，又称为OOB（out of band）区域。而一个块大小是256KB。在SSD中，读写请求被分配到不同的通道的不同的盘面和不同块上，内部可并行访问。

闪存只能单向编程，如只能将一个位的值从1置0，但是相反操作不行，这是由于闪存的物理构造的属性，只能单向充电，但是不能放电，所以一个重写操作必须在擦除原有数据之后执行。为了避免在一次写入操作前存在的潜在擦除操作，FTL重定向写操作到另一个已被擦除过的页上，同时将本次写操作原本定向的页置为无效数据页（这个页会在之后的垃圾回收中被擦除），这就是闪存的不可重复写特性。这个特性能同时保存新的和旧的两个版本的页数据，使得在SSD内部嵌入事务支持变得可行，而支持内部并行需要能同时处理足够多的并发访问请求。并发性在嵌入式事务设计中是能否充分利用SSD性能的关键。



### 事务生命周期

事务支持的执行操作提供了两点功能：1）并发操作的状态一致性。2）系统错误时的恢复。在事务管理中，对事务在并发控制方面提供不同的隔离等级。事务恢复模块保证了原子性和持久性。隔离等级取决于事务并发的程度，比如strict isolation要求事务顺序执行。应用要根据性能和并发程度均衡考虑合适的隔离等级。不论是传统的基于数据的管理系统还是新型的数据密集型应用都有不同的事务隔离需求。因此，在SSD内部设计一种能够灵活兼容不同隔离等级的事务机制是至关重要的。本文中，我们将提供这样一种灵活支持多种隔离等级的事务机制。

一个事务将会贯穿其生命周期的各个不同时期。通常一个事务有4个操作：开始、提交\中止、检查点、擦除，如图例1所示，开始和提交\中止操作用于程序启动或完成一个事务。当一个事务被提交或中止，它的状态能被检测到并且在系统崩溃后恢复，但这需要额外的事务元数据（如日志）的支持。检查点操作将数据写入到他的原始位置并将状态持久化，故可以在不保持事务元数据的情况下使得事务可恢复，例如，在WAL中检查点操作在原地更新一个新版本数据。擦除操作是在事务数据废弃后一种重写或擦除事务数据的操作。因此，一个事务是起于开始操作，死于检查点操作。事务的死亡与事务的提交\中止不同。事务元数据在检查点之前需要被保持，此时事务是活的。图一所示，我们将还没有提交或中止的事务成为活动事务，若它同时也是未通过检查点操作，则称它为活的事务。在一个预写日志系统中，一个事务在提交或中止时完成，在数据被检查点操作时原地更新后死亡。本文中，我们将在FTL利用死亡事务减少事务状态追踪开销。



### 相关工作



---

## LightTx Design



---

## Evaluation



---

## Conclusion

